{% extends 'admin_base.html' %}
{% load static %}
{% block data %}
<!-- 引入 jQuery 和 DataTable 库 -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css">
<style>
    textarea {
        resize: vertical;
        width: auto;
        min-width: 95%;
        /*max-width: 100%;*/
        height: auto;
        min-height: 2em;
        overflow: hidden;
    }

    img {
        width: auto;
        height: auto;
    }

    .buttons-vertical {
        display: flex;
        flex-direction: column;
    }

    .buttons-vertical .btn {
        margin-bottom: 10px;
    }

    .button-container {
        display: flex;
        justify-content: center; /* 水平居中 */
        align-items: flex-end; /* 垂直底部对齐 */
        height: 10%; /* 设置容器高度为单元格高度 */
    }


</style>
<div class="row-fluid sortable ui-sortable">
    <div class="box span11" style="">
        <div class="box-header">
            <h2><i class="halflings-icon white font"></i><span class="break"></span>Step4 Stable Diffusion绘画</h2>
        </div>
        <div class="box-content">
            <div class="row-fluid">
                <div class="span10">
                    <h2>使用说明</h2>
                    <p>1.确保已经开启的web服务，即执行打开【开启Web服务.bat】</p>
                    <p>2.确保已经开启的Stable Diffusion服务，更换模型和VAE请在页面上操作完成</p>
                    <p>3.进入admin管理后台查看需要执行任务的文本已经拆分完毕
                        <button class="btn btn-small btn-primary">
                            <a href="http://127.0.0.1/xadmin/Data/task/" target="_blank">admin</a>
                        </button>
                    </p>
                    <p>4.在管理员给的后台中配置你的SD方法，参数较多请提前配好，并保存</p>
                    <button class="btn btn-small btn-primary">
                        <a href="http://datayang.cn:9999/xadmin" target="_blank">SD云端参数配置</a>
                    </button>
                    <p>5.点击你要执行的任务按钮，在命令行窗口查看执行过程，程序一次性出全部图，如果需要调整重绘请用重绘选项卡</p>
                    <p>6.进入文件夹项目的 media 文件夹下查看自己生成的图片文件，你的项目下的 data_png 是绘制的全部图片</p>
                    <h2>可能存在的问题</h2>
                    <p>1.确保你的Stable Diffusion 更新到最新版本，并打开API模式</p>
                    <p>2.模型选择和参数设置直接影响出图，程序出图和直接用web出图是一样的</p>
                </div>
            </div>
            <div class="row-fluid sortable ui-sortable">
                <div class="box span12">
                    <div class="box-header" data-original-title="">
                        <h2><i class="halflings-icon white user"></i><span class="break"></span>任务数据</h2>
                        <div class="box-icon">
                            <a href="#" class="btn-minimize"><i class="halflings-icon white chevron-up"></i></a>
                        </div>
                    </div>
                    <div class="box-content">
                        <div id="DataTables_Table_0_wrapper" class="dataTables_wrapper" role="grid">
                            <div class="row-fluid">
                            </div>
                            <table class="table table-striped table-bordered bootstrap-datatable datatable dataTable"
                                   id="DataTables_Table_0" aria-describedby="DataTables_Table_0_info">
                                <thead>
                                <tr role="row">
                                    <th class="sorting_asc" role="columnheader" tabindex="0"
                                        aria-controls="DataTables_Table_0" rowspan="1" colspan="1" aria-sort="ascending"
                                        aria-label="Username: activate to sort column descending" style="width: 249px;">
                                        文章类别
                                    </th>
                                    <th class="sorting" role="columnheader" tabindex="0"
                                        aria-controls="DataTables_Table_0" rowspan="1" colspan="1"
                                        aria-label="Date registered: activate to sort column ascending"
                                        style="width: 363px;">文章英文名
                                    </th>
                                    <th class="sorting" role="columnheader" tabindex="0"
                                        aria-controls="DataTables_Table_0" rowspan="1" colspan="1"
                                        aria-label="Role: activate to sort column ascending" style="width: 207px;">
                                        文章中文名
                                    </th>
                                    <th class="sorting" role="columnheader" tabindex="0"
                                        aria-controls="DataTables_Table_0" rowspan="1" colspan="1"
                                        aria-label="Status: activate to sort column ascending" style="width: 220px;">
                                        文章字数
                                    </th>
                                    <th class="sorting" role="columnheader" tabindex="0"
                                        aria-controls="DataTables_Table_0" rowspan="1" colspan="1"
                                        aria-label="Actions: activate to sort column ascending" style="width: 422px;">
                                        Actions
                                    </th>
                                </tr>
                                </thead>

                                <tbody role="alert" aria-live="polite" aria-relevant="all">
                                {% for data in task%}
                                <tr class="odd">
                                    <td class="  sorting_1">{{data.type}}</td>
                                    <td class="center ">{{data.en_name}}</td>
                                    <td class="center ">{{data.cn_name}}</td>
                                    <td class="center ">{{data.len_text}}</td>
                                    <td class="center">
                                        <a href="{% url 'Step_4_1_View' num=data.id %}" class="btn btn-primary">选择</a>
                                    </td>
                                </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div><!--/span-->

            </div>
        </div>
        {% if data_list %}
        <div class="box-content">
            <div class="row-fluid">
                <div class="span10">
                    <h2>使用说明</h2>
                    <p>1.确保已经开启的web服务，即执行打开【开启Web服务.bat】</p>
                    <p>2.确保已经开启的Stable Diffusion服务，更换模型和VAE请在页面上操作完成</p>
                    <p>3.在管理员给的后台中配置你的SD方法，参数较多请提前配好，并保存</p>
                    <p>4.直接点重绘就可以了</p>
                </div>
                <div>
                    <a href="{% url 'Step_4_5_View' num=num%}"
                       class="btn btn-primary">【重置】全部关键词为初始状态</a>
                </div>
                <hr>
                <div>
                    <a href="{% url 'Step_2_2_View' num=num%}"
                       class="btn btn-primary">【生成】全部关键词</a>
                </div>
            </div>
            <div class="row-fluid sortable ui-sortable">
                <div class="box span12">
                    <div class="box-header" data-original-title="">
                        <h2><i class="halflings-icon white user"></i><span class="break"></span>重绘操作</h2>
                        <div class="box-icon">
                            <a href="#" class="btn-minimize"><i class="halflings-icon white chevron-up"></i></a>
                        </div>
                    </div>
                    <div class="box-content">
                        <div id="DataTables_Table_0_wrapper" class="dataTables_wrapper" role="grid">
                            <div class="row-fluid">
                            </div>
                            <table class="table table-striped table-bordered bootstrap-datatable datatable dataTable"
                                   id="DataTables_Table_0" aria-describedby="DataTables_Table_0_info">
                                <thead>
                                <tr role="row">
                                    <th class="sorting_asc" role="columnheader" tabindex="0"
                                        aria-controls="DataTables_Table_0" rowspan="1" colspan="1"
                                        aria-sort="ascending"
                                        aria-label="Username: activate to sort column descending"
                                        style="width: 249px;">
                                        描述
                                    </th>
                                    <th class="sorting" role="columnheader" tabindex="0"
                                        aria-controls="DataTables_Table_0" rowspan="1" colspan="1"
                                        aria-label="Date registered: activate to sort column ascending"
                                        style="width: 363px;">图片
                                    </th>
                                    <th class="sorting" role="columnheader" tabindex="0"
                                        aria-controls="DataTables_Table_0" rowspan="1" colspan="1"
                                        aria-label="Date registered: activate to sort column ascending"
                                        style="width: 363px;">正面词
                                    </th>
                                    <th class="sorting" role="columnheader" tabindex="0"
                                        aria-controls="DataTables_Table_0" rowspan="1" colspan="1"
                                        aria-label="Date registered: activate to sort column ascending"
                                        style="width: 363px;">负面词
                                    </th>
                                    <th class="sorting" role="columnheader" tabindex="0"
                                        aria-controls="DataTables_Table_0" rowspan="1" colspan="1"
                                        aria-label="Date registered: activate to sort column ascending"
                                        style="width: 363px;">LoRA配置
                                    </th>
                                    <th class="sorting" role="columnheader" tabindex="0"
                                        aria-controls="DataTables_Table_0" rowspan="1" colspan="1"
                                        aria-label="Actions: activate to sort column ascending"
                                        style="width: 422px;">
                                        Actions
                                    </th>
                                </tr>
                                </thead>
                                <tbody role="alert" aria-live="polite" aria-relevant="all">
                                {% for each in data_list%}
                                <tr class="odd">
                                    <td class="sorting_1">
                                        <form method="POST" action="{% url 'Step_4_4_View' num=task_id index=each.index%}">
                                            {% csrf_token %}
                                            <textarea name="txt" rows="10">{{each.txt}}</textarea>

                                            <div class="button-container">
                                                <button type="submit" onclick="saveAlert()" class="btn btn-primary">描述保存</button>
                                            </div>
                                        </form>
                                    </td>
                                    <td class="center">
                                        <img src="http://127.0.0.1/txt2video/{{each.img}}" alt="Image">
                                        <hr>
                                        <div class="button-container">
                                            <button onclick="refresh()" class="btn btn-primary">刷新图片</button>
                                        </div>
                                    </td>
                                    <td class="sorting_1">
                                        <form method="POST" action="{% url 'Step_4_4_View' num=task_id index=each.index%}">
                                            {% csrf_token %}
                                            <textarea name="prompt" rows="10">{{each.prompt}}</textarea>
                                            <div class="button-container">
                                                <button type="submit" onclick="saveAlert()" class="btn btn-primary">正面词保存</button>
                                            </div>
                                        </form>
                                    </td>
                                    <td class="sorting_1">
                                        <form method="POST" action="{% url 'Step_4_4_View' num=task_id index=each.index%}">
                                            {% csrf_token %}
                                            <textarea name="negative" rows="10">{{each.negative}}</textarea>
                                            <div class="button-container">
                                                <button type="submit" onclick="saveAlert()" class="btn btn-primary">负面词保存</button>
                                            </div>
                                        </form>
                                    </td>
                                    <td class="center">
                                        <form method="POST" action="{% url 'Step_4_4_View' num=task_id index=each.index%}">
                                            <p>【保存】LoRA会添加到每个Prompt最前面</p>
                                            {% csrf_token %}
                                            <select name="lora">
                                                {% for option in lora_list %}
                                                <option value="{{ option.lora_en_name }}">
                                                    {{ option.lora_cn_name }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                            <div class="button-container">
                                                <button type="submit" onclick="saveAlert()" class="btn btn-primary">LoRA 保存</button>
                                            </div>
                                        </form>
                                        <form method="POST" action="{% url 'Step_4_4_View' num=task_id index=each.index%}">
                                            <p>【添加】当前LoRA到全部Prompt</p>
                                            {% csrf_token %}
                                            <select name="lora_add">
                                                {% for option in lora_list %}
                                                <option value="{{ option.lora_en_name }}">
                                                    {{ option.lora_cn_name }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                            <div class="button-container">
                                                <button type="submit" onclick="refresh()" class="btn btn-primary">添加全部 LoRA</button>
                                            </div>
                                        </form>
                                        <form method="POST" action="{% url 'Step_4_4_View' num=task_id index=each.index%}">
                                            <p>【删除】全部Prompt中的LoRA</p>
                                            {% csrf_token %}
                                            <select name="lora_del">
                                                {% for option in lora_list %}
                                                <option value="{{ option.lora_en_name }}">
                                                    {{ option.lora_cn_name }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                            <div class="button-container">
                                                <button type="submit" onclick="refresh()" class="btn btn-primary">剔除全部 LoRA</button>
                                            </div>
                                        </form>
                                    </td>
                                    <td class="buttons-vertical">
                                        <a href="{% url 'Step_4_3_View' num=task_id index=each.index%}"
                                           class="btn btn-primary">自动重置关键词</a>
                                        <a href="{% url 'Step_4_2_View' num=task_id index=each.index%}"
                                           class="btn btn-primary">重绘图片</a>
                                    </td>
                                </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div><!--/span-->

            </div>
        </div>
        {% endif %}

    </div><!--/span-->

</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


<script>

    // 获取表格对象
    var table = document.getElementById("DataTables_Table_0");
    // 获取描述列所在的索引
    var columnIndex = 0; // 假设描述列是第一列，索引为0
    // 将表格的行转换为数组
    var rows = Array.from(table.getElementsByTagName("tr"));
    // 排除表头行
    var dataRows = rows.slice(1);
    // 根据描述列的值进行排序
    dataRows.sort(function (a, b) {
        var valueA = a.getElementsByTagName("td")[columnIndex].textContent;
        var valueB = b.getElementsByTagName("td")[columnIndex].textContent;
        return valueA.localeCompare(valueB, undefined, {numeric: true, sensitivity: 'base'});
    });
    // 清空表格内容
    while (table.rows.length > 0) {
        table.deleteRow(0);
    }
    // 将排序后的行重新添加到表格中
    dataRows.forEach(function (row) {
        table.appendChild(row);
    });

    // 保存滚动条初始位置
    let scrollTop = $(window).scrollTop();
    $('form').on('submit', function (e) {
        e.preventDefault(); // 阻止默认提交
        // ajax 提交表单
        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: $(this).serialize(),
            success: function () {
                // 成功后滚动到原位置
                $(window).scrollTop(scrollTop);
            }
        });
    });

</script>

<script>
    function refresh() {
        localStorage.setItem('scrollPosition', window.pageYOffset || document.documentElement.scrollTop);
        window.location.reload();
    }

    function saveAlert() {
        localStorage.setItem('scrollPosition', window.pageYOffset || document.documentElement.scrollTop);
        alert('数据已更改');
        window.location.reload();
    }
</script>


{% endblock %}